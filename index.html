<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raffasya Motor - Daftar Harga</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
</head>

<body class="bg-gray-100 min-h-screen">
  <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white text-center py-4 shadow">
    <h1 class="text-3xl font-bold tracking-wide">RAFFASYA MOTOR</h1>
    <p class="text-sm opacity-80 mt-1">Daftar Harga Mobil Terbaru</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- FILTER -->
    <div class="mb-3 flex flex-col md:flex-row gap-3">
      
      <input id="searchInput" type="text" placeholder="Cari merk/type mobil..."
        class="flex-1 border rounded px-4 py-2 shadow-sm focus:ring focus:ring-blue-200" />

      <select id="sortPrice"
        class="w-full md:w-52 border rounded px-4 py-2 shadow-sm focus:ring focus:ring-blue-200">
        <option value="">Urutkan Harga</option>
        <option value="asc">Harga Terendah</option>
        <option value="desc">Harga Tertinggi</option>
      </select>

      <!-- FILTER STATUS BARU -->
      <select id="filterStatus"
        class="w-full md:w-48 border rounded px-4 py-2 shadow-sm focus:ring focus:ring-blue-200">
        <option value="">Semua Status</option>
        <option value="READY">READY</option>
        <option value="BOOKING">BOOKING</option>
        <option value="TERJUAL">TERJUAL</option>
        <option value="COMING SOON">COMING SOON</option>
      </select>

      <button id="resetBtn"
        class="bg-red-500 text-white rounded px-4 py-2 shadow-sm hover:bg-red-600 transition">
        Reset
      </button>
    </div>

    <div id="totalInfo" class="mb-6 text-gray-700 font-medium"></div>
    <div id="mobilList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>

    <div id="loading" class="flex justify-center items-center my-8 hidden">
      <div class="w-12 h-12 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
    </div>

    <div id="endMessage" class="text-center text-gray-500 hidden py-4">
      Semua data sudah dimuat.
    </div>

  </main>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbyr5QyBndUGqeyKgpwRwDDp8g7LnBbvMdpEGadYPWHRtlph9MmwZXgNwP487NtwioZM/exec";

let allData = [], filteredData = [];
let currentSort = "", searchText = "", selectedStatus = "";
let perLoad = 6, currentIndex = 0, isLoading = false;

const listContainer = document.getElementById("mobilList");
const loading = document.getElementById("loading");
const endMessage = document.getElementById("endMessage");
const searchInput = document.getElementById("searchInput");
const sortPrice = document.getElementById("sortPrice");
const filterStatus = document.getElementById("filterStatus");
const resetBtn = document.getElementById("resetBtn");
const totalInfo = document.getElementById("totalInfo");

const F = {
  get(obj, ...keys) {
    for (const k of keys) {
      if (obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") {
        return obj[k];
      }
    }
    return "";
  },
  normStatus(v) { return String(v || "").trim().toUpperCase(); },
  parseRupiahToInt(v) {
    const num = parseInt(String(v || "").replace(/[^\d]/g, ""), 10);
    return isNaN(num) ? 0 : num;
  },
  formatRupiah(v) {
    const n = this.parseRupiahToInt(v);
    return n ? "Rp " + n.toLocaleString("id-ID") : "Rp -";
  }
};

function keyMap(item) {
  return {
    nama: F.get(item, 'MERK/TYPE MOBIL', 'NAMA', 'NAMA MOBIL'),
    nopol: F.get(item, 'NOPOL'),
    harga: F.get(item, 'HARGA JUAL (OTR)', 'HARGA'),
    status: F.normStatus(F.get(item, 'STATUS')),
    photos: []
  };
}

function applyFilter() {
  const source = allData.map(keyMap);

  filteredData = source.filter(x => {
    const matchSearch =
      x.nama.toLowerCase().includes(searchText) ||
      x.nopol.toLowerCase().includes(searchText);

    const matchStatus =
      selectedStatus === "" || x.status === selectedStatus;

    return matchSearch && matchStatus;
  });

  if (currentSort) {
    filteredData.sort((a, b) => {
      const A = F.parseRupiahToInt(a.harga);
      const B = F.parseRupiahToInt(b.harga);
      return currentSort === "asc" ? A - B : B - A;
    });
  }

  const ready = filteredData.filter(x => x.status === 'READY').length;
  const booking = filteredData.filter(x => x.status === 'BOOKING').length;
  const terjual = filteredData.filter(x => x.status === 'TERJUAL').length;
  const comingsoon = filteredData.filter(x => x.status === 'COMING SOON').length;

  totalInfo.innerHTML = `
    Total Unit: 
    <span class="text-green-600">READY: ${ready}</span> |
    <span class="text-blue-600">BOOKING: ${booking}</span> |
    <span class="text-red-600">TERJUAL: ${terjual}</span> |
    <span class="text-gray-600">COMING SOON: ${comingsoon}</span>
  `;

  listContainer.innerHTML = "";
  currentIndex = 0;
  loadMore();
}

function loadMore() {
  const nextData = filteredData.slice(currentIndex, currentIndex + perLoad);

  if (nextData.length === 0) {
    listContainer.innerHTML = `
      <div class="col-span-full text-center text-gray-500 py-10">
        Tidak ada data ditemukan.
      </div>`;
    return;
  }

  nextData.forEach(item => {
    const card = document.createElement("div");
    card.className = "bg-white shadow rounded p-4";

    card.innerHTML = `
      <h2 class="text-lg font-semibold">${item.nama || '-'}</h2>
      <p class="text-sm text-gray-600">Nopol: ${item.nopol || '-'}</p>
      <p class="text-blue-700 font-bold mt-2">
        ${F.formatRupiah(item.harga)} (OTR)
        <span class="ml-2 px-2 py-1 text-xs rounded 
          ${item.status === 'READY' ? 'bg-green-100 text-green-700' :
            item.status === 'BOOKING' ? 'bg-blue-100 text-blue-700' :
            item.status === 'TERJUAL' ? 'bg-red-100 text-red-700' :
            'bg-gray-100 text-gray-600'}">
          ${item.status}
        </span>
      </p>
    `;
    listContainer.appendChild(card);
  });

  currentIndex += perLoad;
}

searchInput.addEventListener("input", () => {
  searchText = searchInput.value.toLowerCase();
  applyFilter();
});

sortPrice.addEventListener("change", () => {
  currentSort = sortPrice.value;
  applyFilter();
});

filterStatus.addEventListener("change", () => {
  selectedStatus = filterStatus.value;
  applyFilter();
});

resetBtn.addEventListener("click", () => {
  searchText = "";
  currentSort = "";
  selectedStatus = "";
  searchInput.value = "";
  sortPrice.value = "";
  filterStatus.value = "";
  applyFilter();
});

async function fetchData() {
  loading.classList.remove("hidden");
  try {
    const res = await fetch(apiURL);
    const json = await res.json();
    allData = Array.isArray(json) ? json : (json.data || []);
  } catch (err) {
    listContainer.innerHTML = `
      <div class="col-span-full text-center text-red-600 py-10">
        Gagal memuat data.
      </div>`;
  } finally {
    applyFilter();
    loading.classList.add("hidden");
  }
}

fetchData();
</script>
</body>
</html>
